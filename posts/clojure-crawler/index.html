<!DOCTYPE html>
<html lang="ja"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
    <title>
      
        Clojureで○○画像を集める | zonukoブログ
      
    </title>
    <meta name="description" content="Clojureで画像を集めてみた">
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css"><link rel="stylesheet" href="/styles.css">
    <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="zonukoブログ">
    <link rel="alternate" href="/feed.json" type="application/json" title="zonukoブログ">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <!-- Google tag (gtag.js) -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-89443473-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'UA-89443473-1');
    </script>
    <!-- Google tag (gtag.js) -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-SQ699WG8QE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-SQ699WG8QE');
    </script>

  <script type="text/javascript" src="/pagefind/pagefind-ui.js"></script><script type="text/javascript">window.addEventListener('DOMContentLoaded', () => { new PagefindUI({"element":"#search","showImages":false,"showEmptyFilters":true,"resetStyles":false,"bundlePath":"/pagefind/","baseUrl":"/"}); });</script></head>
  <body>
    <nav class="navbar">
      <a href="/" class="navbar-home">
        <strong>zonukoブログ</strong>
      </a>

      <ul class="navbar-links">
        <li>
          <a href="/about/">
            About
          </a>
        </li>
        <li>
          <a href="/game/">
            Game
          </a>
        </li>
      </ul>

      <div class="navbar-search">
        <div id="search"></div>
      </div>
    </nav>

    <main class="body-post">
      <div class="main-content">
        <article class="post" data-pagefind-body="">
  <div class="post-header">
    <h1 class="post-title">Clojureで○○画像を集める</h1>

    <nav class="post-tags">
    
      <a href="/tags/clojure/" class="tag">clojure</a>
    
      <a href="/tags/programming/" class="tag">programming</a>
    
    </nav>

    <time class="post-date" datetime="2018-06-12 22:00:00">
      June 12th, 2018
    </time>
    <div class="share">
      <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
      <a href="https://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;"></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
    </div>
  </div>

  <div class="post-body">
    
<section id="clojureで○○画像を集める
">
<h1>Clojureで○○画像を集める</h1>
<p>昔、と言っても一年弱ほど前ですがPythonで画像集めしたことがあって、 Clojureではどうやるんだろうと思ってやってみました。</p>
<section id="使ったもの
">
<h2>使ったもの</h2>
<ul><li><p>Enlive</p><ul><li><p>テンプレートライブラリっぽいですが、 `BeautifulSoup` みたいなことするにはどうしようかとググったら出てきたので使いました。</p></li></ul></li></ul>
</section>
<section id="ソース
">
<h2>ソース</h2>
<p>そんなに大きいソースでも無いのでいきなり貼っちゃいます。</p>
<pre><code class="language-clojure hljs">(<span class="hljs-name"><span class="hljs-built_in">ns</span></span> crawler.core
  (<span class="hljs-symbol">:require</span> [net.cgrand.enlive-html <span class="hljs-symbol">:as</span> enlive]
            [clojure.edn <span class="hljs-symbol">:as</span> edn]
            [ring.util.codec <span class="hljs-symbol">:refer</span> [url-encode]]
            [clojure.java.io <span class="hljs-symbol">:refer</span> [copy input-stream output-stream]]))

<span class="hljs-comment">;; ここで999エラーが帰ってくる可能性がある</span>
<span class="hljs-comment">;; yahooは1時間に400回まで</span>
(<span class="hljs-keyword">defn</span> <span class="hljs-title">get-contents</span> [uri]
  (<span class="hljs-name"><span class="hljs-built_in">-&gt;</span></span> (<span class="hljs-name">java.net.URI.</span> uri)
      enlive/html-resource))

<span class="hljs-comment">;; ダウンロードのURL接続は直接もとのサイトに行っているならアクセス制限にかからないはず</span>
(<span class="hljs-keyword">defn</span> <span class="hljs-title">download</span> [{{src <span class="hljs-symbol">:href</span>} <span class="hljs-symbol">:attrs</span>} path]
  (<span class="hljs-name"><span class="hljs-built_in">let</span></span> [bytes (<span class="hljs-name">java.io.ByteArrayOutputStream.</span>)] 
    (<span class="hljs-name"><span class="hljs-built_in">with-open</span></span> [pic (<span class="hljs-name">input-stream</span> src)
                out (<span class="hljs-name">output-stream</span> path)] 
      (<span class="hljs-name">copy</span> pic bytes) <span class="hljs-comment">;; URLからメモリにロード</span>
      (<span class="hljs-name">.write</span> out (<span class="hljs-name">.toByteArray</span> bytes)))))

(<span class="hljs-keyword">defn</span> <span class="hljs-title">get-by-tagname</span> [uri &amp; tags]
  (<span class="hljs-name"><span class="hljs-built_in">let</span></span> [pics (<span class="hljs-name"><span class="hljs-built_in">-&gt;</span></span> uri
                 get-contents
                 (<span class="hljs-name">enlive/select</span> tags))] 
    (<span class="hljs-name"><span class="hljs-built_in">if</span></span> (<span class="hljs-name"><span class="hljs-built_in">zero?</span></span> (<span class="hljs-name"><span class="hljs-built_in">count</span></span> pics))
      <span class="hljs-literal">nil</span>
      pics)))

(<span class="hljs-keyword">defn</span> <span class="hljs-title">run</span> []
  (<span class="hljs-name"><span class="hljs-built_in">let</span></span> [config (<span class="hljs-name">edn/read-string</span> (<span class="hljs-name"><span class="hljs-built_in">slurp</span></span> <span class="hljs-string">"config.edn"</span>))
        org-word (<span class="hljs-name"><span class="hljs-built_in">get</span></span> config <span class="hljs-string">"word"</span>)
        words (<span class="hljs-name"><span class="hljs-built_in">reduce</span></span> #(<span class="hljs-name"><span class="hljs-built_in">str</span></span> %<span class="hljs-number">1</span> <span class="hljs-string">"+"</span> %<span class="hljs-number">2</span>) (<span class="hljs-name"><span class="hljs-built_in">first</span></span> org-word) (<span class="hljs-name"><span class="hljs-built_in">rest</span></span> org-word))
        word (<span class="hljs-name">url-encode</span> words)
        org-url (<span class="hljs-name"><span class="hljs-built_in">get</span></span> config <span class="hljs-string">"url"</span>)
        dir (<span class="hljs-name"><span class="hljs-built_in">get</span></span> config <span class="hljs-string">"dir"</span>)
        b (<span class="hljs-name"><span class="hljs-built_in">get</span></span> config <span class="hljs-string">"page"</span>)
        step (<span class="hljs-name"><span class="hljs-built_in">get</span></span> config <span class="hljs-string">"step"</span>)]
    (<span class="hljs-name"><span class="hljs-built_in">loop</span></span> [page <span class="hljs-number">1</span>
           max <span class="hljs-number">1</span>
           url (<span class="hljs-name"><span class="hljs-built_in">format</span></span> org-url word b)] 
      (<span class="hljs-name"><span class="hljs-built_in">if-let</span></span> [pics (<span class="hljs-name">get-by-tagname</span> url <span class="hljs-symbol">:div#ISm</span> <span class="hljs-symbol">:div.gridmodule</span> <span class="hljs-symbol">:div.SeR</span> <span class="hljs-symbol">:p.tb</span> <span class="hljs-symbol">:a</span>)]
        (<span class="hljs-name"><span class="hljs-built_in">do</span></span>
          (<span class="hljs-name"><span class="hljs-built_in">doseq</span></span> [[pic names] (<span class="hljs-name"><span class="hljs-built_in">map</span></span> (<span class="hljs-name"><span class="hljs-built_in">fn</span></span> [p idx] [p idx]) pics (<span class="hljs-name"><span class="hljs-built_in">take</span></span> <span class="hljs-number">20</span> (<span class="hljs-name"><span class="hljs-built_in">iterate</span></span> inc max)))]
            (<span class="hljs-name">download</span> pic (<span class="hljs-name"><span class="hljs-built_in">str</span></span> dir words <span class="hljs-string">"-"</span> names <span class="hljs-string">".png"</span>))) 
          (<span class="hljs-name">Thread/sleep</span> <span class="hljs-number">10000</span>) <span class="hljs-comment">;; 10秒間スリープ</span>
          (<span class="hljs-name"><span class="hljs-built_in">recur</span></span> (<span class="hljs-name"><span class="hljs-built_in">inc</span></span> page) (<span class="hljs-name"><span class="hljs-built_in">inc</span></span> (<span class="hljs-name"><span class="hljs-built_in">*</span></span> page step <span class="hljs-number">10</span>)) (<span class="hljs-name"><span class="hljs-built_in">format</span></span> org-url word (<span class="hljs-name"><span class="hljs-built_in">inc</span></span> (<span class="hljs-name"><span class="hljs-built_in">*</span></span> page step <span class="hljs-number">10</span>)))))
        <span class="hljs-literal">nil</span>))))
</code></pre>
<p>`run` 関数が大きくなっちゃってるのが気になる。</p>
<p>基本的にはyahoo画像検索の簡易検索から持ってくることにしてます。 単純にURLのクエリにページ情報とかが含まれているのでクロールしやすいってだけです。</p>
<p>また、設定ファイルを `config.edn` として外出しています。</p>
<pre><code class="language-clojure hljs">{<span class="hljs-string">"url"</span> <span class="hljs-string">"https://search.yahoo.co.jp/image/search?p=%s&amp;ei=UTF-8&amp;b=%s"</span>
 <span class="hljs-string">"word"</span> [<span class="hljs-string">"呪怨"</span>]
 <span class="hljs-string">"page"</span> <span class="hljs-number">1</span>
 <span class="hljs-string">"dir"</span> <span class="hljs-string">"pic/"</span>
 <span class="hljs-string">"step"</span> <span class="hljs-number">2</span>}
</code></pre>
<p>保存先のフォルダとか検索語リストだとかを入れてます。1ページ20件と決まっているならstepは不要だったかも。</p>
<p>実際動かしてみると呪怨画像が溜まっているのがわかります。</p>
<img alt=" Crawler
" src="/images/Crawler.gif">
</section>
<section id="まとめ
">
<h2>まとめ</h2>
<p>yahoo画像検索ではエロ画像は取得できない!</p>
</section>
</section>


  </div>
</article>


<hr>

<nav class="post-navigation">
  <ul>
    <li>
      ← Previous: <a href="/posts/job-change/" rel="prev">そろそろ誕生日だし転職活動しようと思う</a>
    </li>
    
    <li>
      <strong>Next: <a href="/posts/blog-to-lume/" rel="next">blogをdeno製静的サイトジェネレーターlumeに移植した</a> →</strong>
    </li>
    
  </ul>
</nav>
      </div>
      <div class="sidebar">
        <aside>
          <section>
            <ul>
              <li>
                <h4>
                  <i class="fa-solid fa-link"></i>
                  <span>Social</span>
                </h4>
                <ul>
                  <li>
                    <i class="fa-brands fa-twitter"></i>
                    <span><a href="https://twitter.com/nuhera" target="_blank" rel="noopener noreferrer">Twitter</a></span>
                </li></ul>
              </li>
              <li>
                <h4>
                  <i class="fa-solid fa-newspaper"></i>
                  <span>Recent Posts</span>
                </h4>
                <ul>
                    <li><a href="https://zonuko.github.io/posts/blog-to-lume/">blogをdeno製静的サイトジェネレーターlumeに移植した</a></li>
                    <li><a href="https://zonuko.github.io/posts/clojure-crawler/">Clojureで○○画像を集める</a></li>
                    <li><a href="https://zonuko.github.io/posts/job-change/">そろそろ誕生日だし転職活動しようと思う</a></li>
                    <li><a href="https://zonuko.github.io/posts/professional-clojure1/">Professional Clojureメモその1</a></li>
                    <li><a href="https://zonuko.github.io/posts/inventory/">社会に出て3年間でやってたこと</a></li>
                </ul>
              </li>
              <li>
                <h4><i class="fa-solid fa-tag"></i><span>Tags</span>
                <ul>
                  
                    <li><a href="/tags/career/">career</a></li>
                  
                    <li><a href="/tags/clojure/">clojure</a></li>
                  
                    <li><a href="/tags/deno/">deno</a></li>
                  
                    <li><a href="/tags/elixir/">elixir</a></li>
                  
                    <li><a href="/tags/game/">game</a></li>
                  
                    <li><a href="/tags/javascript/">javascript</a></li>
                  
                    <li><a href="/tags/misc/">misc</a></li>
                  
                    <li><a href="/tags/music/">music</a></li>
                  
                    <li><a href="/tags/phoenix/">phoenix</a></li>
                  
                    <li><a href="/tags/programming/">programming</a></li>
                  
                </ul>
              </h4></li>
            </ul>
        </section></aside>
      </div>
    </main>

    <footer></footer>

    <!-- Current page: /posts/clojure-crawler/ -->
  

</body></html>