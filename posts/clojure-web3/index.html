<!DOCTYPE html>
<html lang="ja"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
    <title>
      
        ClojureでWebアプリ続きの続き(外部APIと連携するchannel) | zonukoブログ
      
    </title>
    <meta name="description" content="ClojureでWebアプリ作ってみたつづきその2">
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css"><link rel="stylesheet" href="/styles.css">
    <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="zonukoブログ">
    <link rel="alternate" href="/feed.json" type="application/json" title="zonukoブログ">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <!-- Google tag (gtag.js) -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-89443473-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'UA-89443473-1');
    </script>
    <!-- Google tag (gtag.js) -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-SQ699WG8QE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-SQ699WG8QE');
    </script>

  <script type="text/javascript" src="/pagefind/pagefind-ui.js"></script><script type="text/javascript">window.addEventListener('DOMContentLoaded', () => { new PagefindUI({"element":"#search","showImages":false,"showEmptyFilters":true,"resetStyles":false,"bundlePath":"/pagefind/","baseUrl":"/"}); });</script></head>
  <body>
    <nav class="navbar">
      <a href="/" class="navbar-home">
        <strong>zonukoブログ</strong>
      </a>

      <ul class="navbar-links">
        <li>
          <a href="/about/">
            About
          </a>
        </li>
        <li>
          <a href="/game/">
            Game
          </a>
        </li>
      </ul>

      <div class="navbar-search">
        <div id="search"></div>
      </div>
    </nav>

    <main class="body-post">
      <div class="main-content">
        <article class="post" data-pagefind-body="">
  <div class="post-header">
    <h1 class="post-title">ClojureでWebアプリ続きの続き(外部APIと連携するchannel)</h1>

    <nav class="post-tags">
    
      <a href="/tags/clojure/" class="tag">clojure</a>
    
      <a href="/tags/programming/" class="tag">programming</a>
    
    </nav>

    <time class="post-date" datetime="2018-05-24 23:00:00">
      May 24th, 2018
    </time>
    <div class="share">
      <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
      <a href="https://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;"></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
    </div>
  </div>

  <div class="post-body">
    
<section id="clojureでwebアプリ続きの続き(外部apiと連携するchannel)
">
<h1>ClojureでWebアプリ続きの続き(外部APIと連携するchannel)</h1>
<p>真面目に前回で終わりだと思ってたんですが、 `core.async` とか調べている内に意欲が・・・</p>
<p>今回はWolfram Alphaって言う質問応答サービスを利用してチャットにQAを組み込みます。 結構前に書いてたProgramming Phoenixで最後の方にやってたやつと似たような感じです。</p>
<section id="導入
">
<h2>導入</h2>
<p>今回は以下を使いました。</p>
<ul><li><p>`[com.stuartsierra/component "0.3.2"]`</p><ul><li><p>`sente` のソケットとAPI問い合わせ用の `channel` を管理するためです。ついでに使ってみようってことで。</p></li></ul></li></ul>
<p>また、チャットにて@wolframが最初についているものを対象リクエストとみなします。</p>
</section>
<section id="問い合わせ部分の本体実装
">
<h2>問い合わせ部分の本体実装</h2>
<p>`channel` で待ち受けてAPIに問い合わせるだけです。</p>
<pre><code class="language-Clojure hljs">(<span class="hljs-name"><span class="hljs-built_in">ns</span></span> earth-clj.wolfram
  (<span class="hljs-symbol">:require</span> [clojure.core.async <span class="hljs-symbol">:refer</span> [go-loop &lt;! &gt;!]]
            [ring.util.codec <span class="hljs-symbol">:as</span> codec]
            [earth-clj.socket <span class="hljs-symbol">:refer</span> [ch-chsk]]
            [clojure.xml <span class="hljs-symbol">:as</span> xml]
            [clojure.zip <span class="hljs-symbol">:as</span> zip]))

<span class="hljs-comment">;; <span class="hljs-doctag">TODO:</span> pipeとかpipelineを使ってch-chskとwolfram-chをつなげる</span>

(<span class="hljs-keyword">defonce</span> ^<span class="hljs-symbol">:private</span> <span class="hljs-title">app-id</span> <span class="hljs-string">"XXXXX-XXXXXXXXX"</span>)

(<span class="hljs-keyword">defn-</span> <span class="hljs-title">make-url</span> [input]
  (<span class="hljs-name">println</span> input)
  (<span class="hljs-name"><span class="hljs-built_in">str</span></span> <span class="hljs-string">"http://api.wolframalpha.com/v2/query?appid="</span>
       app-id
       <span class="hljs-string">"&amp;input="</span>
       (<span class="hljs-name">codec/url-encode</span> input)
       <span class="hljs-string">"&amp;format=plaintext"</span>))

(<span class="hljs-keyword">defn-</span> <span class="hljs-title">xml-&gt;data</span> [input]
  (<span class="hljs-name">some-&gt;</span> input
          make-url
          xml/parse
          zip/xml-zip
          zip/down
          zip/right
          zip/down
          zip/down
          zip/down
          first))

(<span class="hljs-keyword">defn</span> <span class="hljs-title">start-wolfram-service</span> [wolfram-ch]
  (<span class="hljs-name">go-loop</span> []
    (<span class="hljs-name"><span class="hljs-built_in">when-let</span></span> [{<span class="hljs-symbol">:as</span> ev-msg <span class="hljs-symbol">:keys</span> [ring-req ?data]} (<span class="hljs-name">&lt;!</span> wolfram-ch)]
      (<span class="hljs-name">&gt;!</span> (<span class="hljs-symbol">:reader</span> ring-req) (<span class="hljs-name"><span class="hljs-built_in">assoc</span></span> ev-msg <span class="hljs-symbol">:?data</span>
                                           (<span class="hljs-name"><span class="hljs-built_in">if-let</span></span> [ans (<span class="hljs-name">xml-&gt;data</span> ?data)]
                                             ans
                                             <span class="hljs-string">"I have no idea."</span>)))
      (<span class="hljs-name"><span class="hljs-built_in">recur</span></span>))))
</code></pre>
<p>`go-loop` で待ち受けて何か来たらWolfram Aplhaからxmlもらってくる感じです。 `some-&gt;` とか初めて使いました。 データが取得出来たらDB登録用の `channel` にデータを突っ込みます。</p>
<p>また、 `xml-zip` 使うと木構造みたいな感じにしてくれるのであとは適当に探索すればよかったので それなりに楽でした。(使い方を掴むまでは結構試行錯誤でしたが・・・)</p>
</section>
<section id="sente側
">
<h2>sente側</h2>
<p>`sente` 側は `websocket` を通して来たリクエストに対して、正規表現を使って場合分けするだけです。</p>
<pre><code class="language-Clojure hljs"><span class="hljs-comment">;; 正規表現</span>
(<span class="hljs-keyword">def</span> ^<span class="hljs-symbol">:private</span> <span class="hljs-title">prefix</span> <span class="hljs-regex">#"(^@wolfram)(.*)"</span>)

(<span class="hljs-keyword">defmethod</span> <span class="hljs-title">-event-msg-handler</span>
  <span class="hljs-symbol">:chat/post</span>
  [{<span class="hljs-symbol">:as</span> ev-msg <span class="hljs-symbol">:keys</span> [event id ?data ring-req ?reply-fn send-fn]}]
  <span class="hljs-comment">;; nthでも良いけどIndex~の例外が出るのでlastにする</span>
  <span class="hljs-comment">;; 正規表現的に最大でも3つの要素のvectorになる</span>
  (<span class="hljs-name"><span class="hljs-built_in">when-let</span></span> [msg (<span class="hljs-name"><span class="hljs-built_in">last</span></span> (<span class="hljs-name"><span class="hljs-built_in">re-find</span></span> prefix ?data))]
    (<span class="hljs-name">go</span>
      (<span class="hljs-name">&gt;!</span> (<span class="hljs-symbol">:qasystem</span> ring-req) (<span class="hljs-name"><span class="hljs-built_in">assoc</span></span> ev-msg <span class="hljs-symbol">:?data</span> msg))))
  (<span class="hljs-name">message/add-messages</span> (<span class="hljs-name"><span class="hljs-built_in">get-in</span></span> ring-req [<span class="hljs-symbol">:session</span> <span class="hljs-symbol">:identity</span>]) ?data)
  (<span class="hljs-name">msgs-broadcast</span>))

<span class="hljs-comment">;; Wolframから返されるものを待ち受ける</span>
(<span class="hljs-keyword">defn</span> <span class="hljs-title">watch-wolfram-service</span> [watch-ch]
  (<span class="hljs-name">go-loop</span> []
    (<span class="hljs-name"><span class="hljs-built_in">when-let</span></span> [{<span class="hljs-symbol">:as</span> ev-msg <span class="hljs-symbol">:keys</span> [ring-req ?data]} (<span class="hljs-name">&lt;!</span> watch-ch)]
      (<span class="hljs-name">message/add-messages</span> (<span class="hljs-name"><span class="hljs-built_in">get-in</span></span> ring-req [<span class="hljs-symbol">:session</span> <span class="hljs-symbol">:identity</span>]) ?data)
      (<span class="hljs-name">msgs-broadcast</span>)
      (<span class="hljs-name"><span class="hljs-built_in">recur</span></span>))))
</code></pre>
<p>`watch-wolfram-service` を `component` から起動される関数にしています。 これはWolfram側から問い合わせが来る `go-loop` になってます。</p>
<p>結局 `channel` をコールバックみたいにしか使えてないのが心残り・・・</p>
</section>
<section id="コンポーネントの実装
">
<h2>コンポーネントの実装</h2>
<p>ここまで作ったものとサーバーの起動をまとめます。</p>
<pre><code class="language-Clojure hljs">(<span class="hljs-name"><span class="hljs-built_in">ns</span></span> earth-clj.component
  (<span class="hljs-symbol">:use</span> [org.httpkit.server <span class="hljs-symbol">:only</span> [run-server]])
  (<span class="hljs-symbol">:require</span> [com.stuartsierra.component <span class="hljs-symbol">:as</span> component]
            [taoensso.sente <span class="hljs-symbol">:as</span> sente]
            [clojure.core.async <span class="hljs-symbol">:refer</span> [go-loop &lt;! &gt;! chan] <span class="hljs-symbol">:as</span> async]
            [earth-clj.socket <span class="hljs-symbol">:as</span> socket]
            [earth-clj.wolfram <span class="hljs-symbol">:as</span> wolfram]
            [earth-clj.core <span class="hljs-symbol">:as</span> earth]))

<span class="hljs-comment">;; 基本的には変更可能な状態をコンポーネントに押し込めるイメージ</span>
<span class="hljs-comment">;; 単純にrefやatomで持ってたものをrouter_などのローカル変数に押し込める</span>

(<span class="hljs-keyword">defrecord</span> <span class="hljs-title">Wolfram</span> [qasystem]
  component/Lifecycle
  (<span class="hljs-name">start</span> [this]
    (<span class="hljs-name"><span class="hljs-built_in">let</span></span> [wolfram-ch (<span class="hljs-name">chan</span>)]
      (<span class="hljs-name">println</span> <span class="hljs-string">";; Starting Wolfram Alpha"</span>)
      (<span class="hljs-name">wolfram/start-wolfram-service</span> wolfram-ch)
      (<span class="hljs-name"><span class="hljs-built_in">assoc</span></span> this <span class="hljs-symbol">:qasystem</span> wolfram-ch)))
  (<span class="hljs-name">stop</span> [this]
    (<span class="hljs-name">println</span> <span class="hljs-string">";; Wolfram stopped"</span>)
    (<span class="hljs-name"><span class="hljs-built_in">assoc</span></span> this <span class="hljs-symbol">:qasystem</span> <span class="hljs-literal">nil</span>)))

(<span class="hljs-keyword">defn</span> <span class="hljs-title">create-wolfram</span> []
  (<span class="hljs-name">map-&gt;Wolfram</span> {}))

<span class="hljs-comment">;; WebSocketコンポーネント</span>
(<span class="hljs-keyword">defrecord</span> <span class="hljs-title">Socket</span> [router]
  component/Lifecycle
  (<span class="hljs-name">start</span> [this]
    (<span class="hljs-name"><span class="hljs-built_in">if</span></span> router
      this
      (<span class="hljs-name"><span class="hljs-built_in">do</span></span> (<span class="hljs-name">println</span> <span class="hljs-string">";; Starting Chat Socket"</span>)
          (<span class="hljs-name"><span class="hljs-built_in">let</span></span> [router_ (<span class="hljs-name">sente/start-server-chsk-router!</span> socket/ch-chsk socket/event-msg-handler)
                read-ch (<span class="hljs-name">chan</span>)]
            (<span class="hljs-name">socket/watch-wolfram-service</span> read-ch)
            (<span class="hljs-name"><span class="hljs-built_in">assoc</span></span> this <span class="hljs-symbol">:reader</span> read-ch <span class="hljs-symbol">:router</span> router_)))))
  (<span class="hljs-name">stop</span> [this]
    (<span class="hljs-name"><span class="hljs-built_in">if</span></span> (<span class="hljs-name"><span class="hljs-built_in">not</span></span> router)
      this
      (<span class="hljs-name"><span class="hljs-built_in">do</span></span> (<span class="hljs-name"><span class="hljs-built_in">try</span></span> (<span class="hljs-name">router</span>)                                     <span class="hljs-comment">;; router自身が終了用の関数</span>
               (<span class="hljs-name">catch</span> Throwable t
                 <span class="hljs-string">";; Error when stopping database"</span>))
          (<span class="hljs-name">println</span> <span class="hljs-string">";; Database stopped"</span>)
          (<span class="hljs-name"><span class="hljs-built_in">assoc</span></span> this <span class="hljs-symbol">:reader</span> <span class="hljs-literal">nil</span> <span class="hljs-symbol">:router</span> <span class="hljs-literal">nil</span>)))))

<span class="hljs-comment">;; Socketコンポーネントの作成用関数</span>
(<span class="hljs-keyword">defn</span> <span class="hljs-title">create-socket</span> []
  (<span class="hljs-name">map-&gt;Socket</span> {}))

<span class="hljs-comment">;; requestにQAコンポーネントとその受信用チャネルを追加するミドルウェア</span>
(<span class="hljs-keyword">defn</span> <span class="hljs-title">wrap-app-component</span> [f qa reader]
  (<span class="hljs-name"><span class="hljs-built_in">fn</span></span> [req]
    (<span class="hljs-name">f</span> (<span class="hljs-name"><span class="hljs-built_in">assoc</span></span> req <span class="hljs-symbol">:reader</span> reader <span class="hljs-symbol">:qasystem</span> qa))))

<span class="hljs-comment">;; ミドルウェアを適用したringハンドラを返す関数</span>
(<span class="hljs-keyword">defn</span> <span class="hljs-title">make-handler</span> [qa reader]
  (<span class="hljs-name">wrap-app-component</span> earth/app qa reader))

(<span class="hljs-keyword">defrecord</span> <span class="hljs-title">Server</span> [server host port join? router qasystem]
  component/Lifecycle
  (<span class="hljs-name">start</span> [this]
    (<span class="hljs-name"><span class="hljs-built_in">if</span></span> server
      this
      (<span class="hljs-name"><span class="hljs-built_in">do</span></span> (<span class="hljs-name">println</span> <span class="hljs-string">";; Starting HTTP Server"</span>)
          (<span class="hljs-name"><span class="hljs-built_in">let</span></span> [server (<span class="hljs-name">run-server</span> (<span class="hljs-name">make-handler</span> (<span class="hljs-symbol">:qasystem</span> qasystem) (<span class="hljs-symbol">:reader</span> router))
                                   {<span class="hljs-symbol">:host</span>  host
                                    <span class="hljs-symbol">:port</span>  port
                                    <span class="hljs-symbol">:join?</span> join?})]
            (<span class="hljs-name"><span class="hljs-built_in">assoc</span></span> this <span class="hljs-symbol">:server</span> server)))))
  (<span class="hljs-name">stop</span> [this]
    (<span class="hljs-name"><span class="hljs-built_in">if</span></span> (<span class="hljs-name"><span class="hljs-built_in">not</span></span> server)
      this
      (<span class="hljs-name"><span class="hljs-built_in">do</span></span> (<span class="hljs-name"><span class="hljs-built_in">try</span></span> (<span class="hljs-name">server</span>)                                     <span class="hljs-comment">;; http-kitの終了</span>
               (<span class="hljs-name">catch</span> Throwable t
                 (<span class="hljs-name">print</span> <span class="hljs-string">";; Error when stopping HTTP server"</span>)))
          (<span class="hljs-name">println</span> <span class="hljs-string">";; HTTP server stopped"</span>)
          (<span class="hljs-name"><span class="hljs-built_in">assoc</span></span> this <span class="hljs-symbol">:server</span> <span class="hljs-literal">nil</span>)))))

<span class="hljs-comment">;; HTTPサーバコンポーネント</span>
(<span class="hljs-keyword">defn</span> <span class="hljs-title">create-http-server</span> [host port join?]
  <span class="hljs-comment">;; map-&gt;ReacodNameで引数に与えられたMapからレコードを生成する</span>
  (<span class="hljs-name">map-&gt;Server</span> {<span class="hljs-symbol">:host</span> host <span class="hljs-symbol">:port</span> port <span class="hljs-symbol">:join?</span> join?}))

<span class="hljs-comment">;; システム作成用関数</span>
(<span class="hljs-keyword">defn</span> <span class="hljs-title">create-system</span> [&amp; {<span class="hljs-symbol">:keys</span> [host port join?]
                        <span class="hljs-symbol">:or</span>   {host <span class="hljs-string">"localhost"</span> port <span class="hljs-number">4000</span> join? <span class="hljs-literal">false</span>}}]
  (<span class="hljs-name">component/system-map</span>
    <span class="hljs-symbol">:qasystem</span> (<span class="hljs-name">create-wolfram</span>)
    <span class="hljs-symbol">:router</span> (<span class="hljs-name">create-socket</span>)
    <span class="hljs-symbol">:server</span> (<span class="hljs-name">component/using</span>
              (<span class="hljs-name">create-http-server</span> host port join?)
              [<span class="hljs-symbol">:router</span> <span class="hljs-symbol">:qasystem</span>])))
</code></pre>
<p>使い方が合っているかは謎。 `let` とかで作ったchannelを引数に渡すことで `go-loop` を起動してたりします。 また、 `qasystem` と `router` は互いに依存してますが、 `component/using` でやろうとすると 怒られたので `server` がどちらにも依存しているって形式にしました。</p>
<p>あとはリクエストマップに `channel` を押し込んでいる部分ですがこれでいいのかかなり微妙な気分ではあります。</p>
</section>
<section id="出来たもの
">
<h2>出来たもの</h2>
<p>Twitterにも似たようなの投稿しましたが出来たものは以下みたいなやつです。 <a href="mailto:`@wolfram">`@wolfram</a> qa` でちゃんとした質問なら `qa` の回答が自動で帰ってきます。</p>
<img src="/images/Wolfram.gif">
<p>  :alt: Quicksilver</p>
</section>
<section id="まとめ
">
<h2>まとめ</h2>
<ul>
<li><p>`component` はPhoenixのUmbrellaに似ていると思った</p><ul>
<li><p>やろうと思えば `channel` 同士の依存とかも管理できそう？　</p></li>
<li><p>依存先が落ちたら再起動とか出来るんだろうか</p></li>
</ul></li>
<li><p>`core.async` の簡単な使い方が分かった</p><ul><li><p>本当は `pipeline` とか `pipe` とか使いたかったですが上手くいかず。</p></li></ul></li>
</ul>
</section>
</section>


  </div>
</article>


<hr>

<nav class="post-navigation">
  <ul>
    <li>
      ← Previous: <a href="/posts/clojure-web2/" rel="prev">ClojureでWebアプリ続き(WebSocketとチャット)</a>
    </li>
    
    <li>
      <strong>Next: <a href="/posts/inventory/" rel="next">社会に出て3年間でやってたこと</a> →</strong>
    </li>
    
  </ul>
</nav>
      </div>
      <div class="sidebar">
        <aside>
          <section>
            <ul>
              <li>
                <h4>
                  <i class="fa-solid fa-link"></i>
                  <span>Social</span>
                </h4>
                <ul>
                  <li>
                    <i class="fa-brands fa-twitter"></i>
                    <span><a href="https://twitter.com/nuhera" target="_blank" rel="noopener noreferrer">Twitter</a></span>
                </li></ul>
              </li>
              <li>
                <h4>
                  <i class="fa-solid fa-newspaper"></i>
                  <span>Recent Posts</span>
                </h4>
                <ul>
                    <li><a href="https://zonuko.github.io/posts/blog-to-lume/">blogをdeno製静的サイトジェネレーターlumeに移植した</a></li>
                    <li><a href="https://zonuko.github.io/posts/clojure-crawler/">Clojureで○○画像を集める</a></li>
                    <li><a href="https://zonuko.github.io/posts/job-change/">そろそろ誕生日だし転職活動しようと思う</a></li>
                    <li><a href="https://zonuko.github.io/posts/professional-clojure1/">Professional Clojureメモその1</a></li>
                    <li><a href="https://zonuko.github.io/posts/inventory/">社会に出て3年間でやってたこと</a></li>
                </ul>
              </li>
              <li>
                <h4><i class="fa-solid fa-tag"></i><span>Tags</span>
                <ul>
                  
                    <li><a href="/tags/career/">career</a></li>
                  
                    <li><a href="/tags/clojure/">clojure</a></li>
                  
                    <li><a href="/tags/deno/">deno</a></li>
                  
                    <li><a href="/tags/elixir/">elixir</a></li>
                  
                    <li><a href="/tags/game/">game</a></li>
                  
                    <li><a href="/tags/javascript/">javascript</a></li>
                  
                    <li><a href="/tags/misc/">misc</a></li>
                  
                    <li><a href="/tags/music/">music</a></li>
                  
                    <li><a href="/tags/phoenix/">phoenix</a></li>
                  
                    <li><a href="/tags/programming/">programming</a></li>
                  
                </ul>
              </h4></li>
            </ul>
        </section></aside>
      </div>
    </main>

    <footer></footer>

    <!-- Current page: /posts/clojure-web3/ -->
  

</body></html>