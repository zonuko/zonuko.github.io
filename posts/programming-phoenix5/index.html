<!DOCTYPE html>
<html lang="ja"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
    <title>
      
        Programming Phoenix勉強その5 | zonukoブログ
      
    </title>
    <meta name="description" content="Programming Phoenixって本を読むその5">
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css"><link rel="stylesheet" href="/styles.css">
    <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="zonukoブログ">
    <link rel="alternate" href="/feed.json" type="application/json" title="zonukoブログ">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <!-- Google tag (gtag.js) -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-89443473-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'UA-89443473-1');
    </script>
    <!-- Google tag (gtag.js) -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-SQ699WG8QE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-SQ699WG8QE');
    </script>

  <script type="text/javascript" src="/pagefind/pagefind-ui.js"></script><script type="text/javascript">window.addEventListener('DOMContentLoaded', () => { new PagefindUI({"element":"#search","showImages":false,"showEmptyFilters":true,"resetStyles":false,"bundlePath":"/pagefind/","baseUrl":"/"}); });</script></head>
  <body>
    <nav class="navbar">
      <a href="/" class="navbar-home">
        <strong>zonukoブログ</strong>
      </a>

      <ul class="navbar-links">
        <li>
          <a href="/about/">
            About
          </a>
        </li>
        <li>
          <a href="/game/">
            Game
          </a>
        </li>
      </ul>

      <div class="navbar-search">
        <div id="search"></div>
      </div>
    </nav>

    <main class="body-post">
      <div class="main-content">
        <article class="post" data-pagefind-body="">
  <div class="post-header">
    <h1 class="post-title">Programming Phoenix勉強その5</h1>

    <nav class="post-tags">
    
      <a href="/tags/phoenix/" class="tag">phoenix</a>
    
      <a href="/tags/elixir/" class="tag">elixir</a>
    
      <a href="/tags/programming/" class="tag">programming</a>
    
    </nav>

    <time class="post-date" datetime="2017-01-09 17:52:00">
      January 9th, 2017
    </time>
    <div class="share">
      <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
      <a href="https://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;"></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
    </div>
  </div>

  <div class="post-body">
    
<section id="programming-phoenix勉強その5
">
<h1>Programming Phoenix勉強その5</h1>
<p>その5です。ここからChapter4です。 <code>Ecto</code> を使って独自実装してた <code>Repository</code> を <code>Postgres</code> に置き換えていきます。 まず <code>lib/rumbl/repo.ex</code> をもとに戻します。</p>
<pre><code class="language-Elixir hljs"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">Rumbl.Repo</span></span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">use</span> <span class="hljs-title class_">Ecto</span>.<span class="hljs-title class_">Repo</span>, <span class="hljs-symbol">otp_app:</span> <span class="hljs-symbol">:rumbl</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>さらに <code>lib/rumbl.ex</code> でコメントアウトした部分をもとに戻します。</p>
<pre><code class="language-Elixir hljs"><span class="hljs-comment"># Start the Ecto repository</span>
supervisor(<span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Repo</span>, []), <span class="hljs-comment"># ここのコメントアウトを戻す</span>
</code></pre>
<p>まだ <code>mix ecto.create</code> をしてなければしておきます。</p>
<section id="modelの実装
">
<h2>modelの実装</h2>
<p>次に <code>model</code> の実装を行います。 <code>web/model/user.ex</code> を以下の内容で実装します。</p>
<pre><code class="language-Elixir hljs"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">Rumbl.User</span></span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">use</span> <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Web</span>, <span class="hljs-symbol">:model</span>

  schema <span class="hljs-string">"users"</span> <span class="hljs-keyword">do</span>
    field <span class="hljs-symbol">:name</span>, <span class="hljs-symbol">:string</span>
    field <span class="hljs-symbol">:username</span>, <span class="hljs-symbol">:string</span>
    field <span class="hljs-symbol">:password</span>, <span class="hljs-symbol">:string</span>, <span class="hljs-symbol">virtual:</span> <span class="hljs-literal">true</span>
    field <span class="hljs-symbol">:password_hash</span>, <span class="hljs-symbol">:string</span>

    timestamps
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p><code>ActiveRecord</code> 使ったことがあればそんなに違和感なく受け入れられると思います。 <code>:virtual</code> オプションは値として受け取るが、DBには保存しない値です。 ここまで行って起動してみたら以下のような警告が出ました。</p>
<pre><code class="language-shell hljs">warning: variable "timestamps" does not exist and is being expanded to "timestamps()", 
please use parentheses to remove the ambiguity or change the variable name
  web/models/user.ex:10
</code></pre>
<p><code>timestamps</code> が変数なのか <code>timestamps/0</code> の関数呼び出しか曖昧だと言われてるようです。 今回は <code>timestamps/0</code> の呼び出しなので <code>timestamps</code> の部分を <code>timestamps()</code> にすると警告がでなくなります。 <a href="http://www.phoenixframework.org/docs/ecto-models">ここらへん</a> を参考にしました。 最後に <code>web/web.ex</code> の <code>model</code> 関数を以下のように変更します。</p>
<pre><code class="language-Elixir hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">model</span></span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">quote</span> <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">use</span> <span class="hljs-title class_">Ecto</span>.<span class="hljs-title class_">Schema</span>

    <span class="hljs-keyword">import</span> <span class="hljs-title class_">Ecto</span>
    <span class="hljs-keyword">import</span> <span class="hljs-title class_">Ecto</span>.<span class="hljs-title class_">Changeset</span>
    <span class="hljs-keyword">import</span> <span class="hljs-title class_">Ecto</span>.<span class="hljs-title class_">Query</span>, <span class="hljs-symbol">only:</span> [<span class="hljs-symbol">from:</span> <span class="hljs-number">1</span>, <span class="hljs-symbol">from:</span> <span class="hljs-number">2</span>] <span class="hljs-comment"># only以下を追加</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
</section>
<section id="dbのマイグレーション
">
<h2>DBのマイグレーション</h2>
<p>DB側にもテーブルとかを作る必要があるので以下のコマンドを実行します。</p>
<pre><code class="language-shell hljs">rumbl $ mix ecto.gen.migration create_user
* creating priv/repo/migrations
* creating priv/repo/migrations/20170108070642_create_user.exs
</code></pre>
<p>生成された <code>priv/repo/migrations/{日付}_create_user.exs</code> ファイルを以下のように変更します。 これもRailsやったことあれば説明不要だと思います。</p>
<pre><code class="language-Elixir hljs"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">Rumbl.Repo.Migrations.CreateUser</span></span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">use</span> <span class="hljs-title class_">Ecto</span>.<span class="hljs-title class_">Migration</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">change</span></span> <span class="hljs-keyword">do</span>
    create table(<span class="hljs-symbol">:users</span>) <span class="hljs-keyword">do</span>
      add <span class="hljs-symbol">:name</span>, <span class="hljs-symbol">:string</span>
      add <span class="hljs-symbol">:username</span>, <span class="hljs-symbol">:string</span>, <span class="hljs-symbol">null:</span> <span class="hljs-literal">false</span>
      add <span class="hljs-symbol">:password_hash</span>, <span class="hljs-symbol">:string</span>

      timestamps()
    <span class="hljs-keyword">end</span>

    create unique_index(<span class="hljs-symbol">:users</span>, [<span class="hljs-symbol">:username</span>])
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p><code>mix ecto.migrate</code> でマイグレーションを実行します。</p>
</section>
<section id="まとめ
">
<h2>まとめ</h2>
<p><code>Model</code> 周りの話でした。O/Rマッパー使ったことあればあまり違和感なく受け入れられそうでした。 関係ないですけど、基本的な部分終わったらガンガン飛ばしていこうと思います。亀のようなペースだと全然おわらないので。</p>
</section>
</section>


  </div>
</article>


<hr>

<nav class="post-navigation">
  <ul>
    <li>
      ← Previous: <a href="/posts/programming-phoenix4/" rel="prev">Programming Phoenix勉強その4</a>
    </li>
    
    <li>
      <strong>Next: <a href="/posts/programming-phoenix6/" rel="next">Programming Phoenix勉強その6</a> →</strong>
    </li>
    
  </ul>
</nav>
      </div>
      <div class="sidebar">
        <aside>
          <section>
            <ul>
              <li>
                <h4>
                  <i class="fa-solid fa-link"></i>
                  <span>Social</span>
                </h4>
                <ul>
                  <li>
                    <i class="fa-brands fa-twitter"></i>
                    <span><a href="https://twitter.com/nuhera" target="_blank" rel="noopener noreferrer">Twitter</a></span>
                </li></ul>
              </li>
              <li>
                <h4>
                  <i class="fa-solid fa-newspaper"></i>
                  <span>Recent Posts</span>
                </h4>
                <ul>
                    <li><a href="https://zonuko.github.io/posts/blog-to-lume/">blogをdeno製静的サイトジェネレーターlumeに移植した</a></li>
                    <li><a href="https://zonuko.github.io/posts/clojure-crawler/">Clojureで○○画像を集める</a></li>
                    <li><a href="https://zonuko.github.io/posts/job-change/">そろそろ誕生日だし転職活動しようと思う</a></li>
                    <li><a href="https://zonuko.github.io/posts/professional-clojure1/">Professional Clojureメモその1</a></li>
                    <li><a href="https://zonuko.github.io/posts/inventory/">社会に出て3年間でやってたこと</a></li>
                </ul>
              </li>
              <li>
                <h4><i class="fa-solid fa-tag"></i><span>Tags</span>
                <ul>
                  
                    <li><a href="/tags/career/">career</a></li>
                  
                    <li><a href="/tags/clojure/">clojure</a></li>
                  
                    <li><a href="/tags/deno/">deno</a></li>
                  
                    <li><a href="/tags/elixir/">elixir</a></li>
                  
                    <li><a href="/tags/game/">game</a></li>
                  
                    <li><a href="/tags/javascript/">javascript</a></li>
                  
                    <li><a href="/tags/misc/">misc</a></li>
                  
                    <li><a href="/tags/music/">music</a></li>
                  
                    <li><a href="/tags/phoenix/">phoenix</a></li>
                  
                    <li><a href="/tags/programming/">programming</a></li>
                  
                </ul>
              </h4></li>
            </ul>
        </section></aside>
      </div>
    </main>

    <footer></footer>

    <!-- Current page: /posts/programming-phoenix5/ -->
  

</body></html>