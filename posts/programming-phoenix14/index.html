<!DOCTYPE html>
<html lang="ja"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
    <title>
      
        Programming Phoenix勉強その14 | zonukoブログ
      
    </title>
    <meta name="description" content="Programming Phoenixって本を読むその14">
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css"><link rel="stylesheet" href="/styles.css">
    <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="zonukoブログ">
    <link rel="alternate" href="/feed.json" type="application/json" title="zonukoブログ">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <!-- Google tag (gtag.js) -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-89443473-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'UA-89443473-1');
    </script>
    <!-- Google tag (gtag.js) -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-SQ699WG8QE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-SQ699WG8QE');
    </script>

  <script type="text/javascript" src="/pagefind/pagefind-ui.js"></script><script type="text/javascript">window.addEventListener('DOMContentLoaded', () => { new PagefindUI({"element":"#search","showImages":false,"showEmptyFilters":true,"resetStyles":false,"bundlePath":"/pagefind/","baseUrl":"/"}); });</script></head>
  <body>
    <nav class="navbar">
      <a href="/" class="navbar-home">
        <strong>zonukoブログ</strong>
      </a>

      <ul class="navbar-links">
        <li>
          <a href="/about/">
            About
          </a>
        </li>
        <li>
          <a href="/game/">
            Game
          </a>
        </li>
      </ul>

      <div class="navbar-search">
        <div id="search"></div>
      </div>
    </nav>

    <main class="body-post">
      <div class="main-content">
        <article class="post" data-pagefind-body="">
  <div class="post-header">
    <h1 class="post-title">Programming Phoenix勉強その14</h1>

    <nav class="post-tags">
    
      <a href="/tags/phoenix/" class="tag">phoenix</a>
    
      <a href="/tags/elixir/" class="tag">elixir</a>
    
      <a href="/tags/programming/" class="tag">programming</a>
    
    </nav>

    <time class="post-date" datetime="2017-01-31 22:00:00">
      January 31st, 2017
    </time>
    <div class="share">
      <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
      <a href="https://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;"></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
    </div>
  </div>

  <div class="post-body">
    
<section id="programming-phoenix勉強その14
">
<h1>Programming Phoenix勉強その14</h1>
<p>その14です。その13の続きです。追加した <code>Slug</code> をURLに使ってアクセスできるようにします。</p>
<section id="urlのカスタマイズ
">
<h2>URLのカスタマイズ</h2>
<p>URLを単なるID指定から <code>id</code> + 先程作成した <code>slug</code> でアクセスできるようにします。</p>
<p><code>Phoenix.Param</code> を <code>impl</code> することでカスタマイズ可能です。</p>
<pre><code class="language-Elixir hljs"><span class="hljs-class"><span class="hljs-keyword">defimpl</span> <span class="hljs-title">Phoenix.Param</span></span>, <span class="hljs-symbol">for:</span> <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Video</span> <span class="hljs-keyword">do</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">to_param</span></span>(%{<span class="hljs-symbol">slug:</span> slug, <span class="hljs-symbol">id:</span> id}) <span class="hljs-keyword">do</span>
    <span class="hljs-string">"<span class="hljs-subst">#{id}</span>-<span class="hljs-subst">#{slug}</span>"</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p><a href="https://hexdocs.pm/phoenix/Phoenix.Param.html">公式ドキュメント</a> を見ると単なる <code>impl</code> なら @derive {Phoenix.Param, key: :username} で行けるようです。 今回は <code>"#{id}-#{slug}"</code> などのちょっとカスタムされたURLでアクセスしたいので直接実装してます。（ <code>derive</code> で実装できる方法はあるのだろうか・・・）</p>
<p><code>IEX</code> で上記で作成したものを試してみます。</p>
<pre><code class="language-shell hljs"><span class="hljs-meta prompt_">iex&gt; </span><span class="language-bash">video = %Rumbl.Video{<span class="hljs-built_in">id</span>: 1, slug: <span class="hljs-string">"hello"</span>}</span>
<span class="hljs-meta prompt_">iex&gt; </span><span class="language-bash">Rumbl.Router.Helpers.watch_path(%URI{}, :show, video)</span>
"/watch/1-hello"
</code></pre>
<p><code>watch_path/3</code> の第一引数が <code>%URI{}</code> となっています。すべてのヘルパーはこのURI構造体を第一引数を取るらしいです。</p>
<p>URI構造体を使ってちょっと遊んでみます。</p>
<pre><code class="language-shell hljs"><span class="hljs-meta prompt_">iex&gt; </span><span class="language-bash">url = URI.parse(<span class="hljs-string">"http://example.com/prefix"</span>)</span>
<span class="hljs-meta prompt_">%</span><span class="language-bash">URI{authority: <span class="hljs-string">"example.com"</span>, fragment: nil, host: <span class="hljs-string">"example.com"</span>,</span>
 path: "/prefix", port: 80, query: nil, scheme: "http", userinfo: nil}
<span class="hljs-meta prompt_">iex(6)&gt; </span><span class="language-bash">Rumbl.Router.Helpers.watch_url(url, :show, video)</span>
"http://example.com/prefix/watch/1-hello"
</code></pre>
<p>第一引数に与えたURLに続くパスとしてパスを構築してくれていることがわかります。じゃあ今使っている <code>localhost</code> のURLはどうなってんだという疑問がわきます。 以下を試してみます。</p>
<pre><code class="language-shell hljs"><span class="hljs-meta prompt_">iex&gt; </span><span class="language-bash">url = Rumbl.Endpoint.struct_url</span>
<span class="hljs-meta prompt_">%</span><span class="language-bash">URI{authority: nil, fragment: nil, host: <span class="hljs-string">"localhost"</span>, path: nil, port: 4000,</span>
 query: nil, scheme: "http", userinfo: nil}
<span class="hljs-meta prompt_">iex(8)&gt; </span><span class="language-bash">Rumbl.Router.Helpers.watch_url(url, :show, video)</span>
"http://localhost:4000/watch/1-hello"
</code></pre>
<p>どうやら内部的には <code>struct_url</code> で全体のURLが構築されているらしいことがわかります。また、 <code>url</code> というAPIもあるようです。 こちらは文字列でURL全体を返してくれます。</p>
<p>ここまでやって、ウォッチページにとぼうとするとエラーになります。 <code>watch_controller</code> の <code>:show</code> アクションではURLパラメータとして <code>:id</code> を期待しているのに <code>1-hello</code> のようなパラメータが来ているためです。これからこの点を修正します。</p>
</section>
<section id="リンクの修正
">
<h2>リンクの修正</h2>
<p>上記の問題を解決するためにリンクを修正します。 <code>lib/rumbl/permalink.ex</code> を実装します。 ちなみに <code>lib</code> フォルダと <code>web</code> フォルダの違いはコードリロードが走るかどうかの違いのようです。</p>
<pre><code class="language-Elixir hljs"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">Rumbl.Permalink</span></span> <span class="hljs-keyword">do</span>
  <span class="hljs-comment"># cast,dump,load,typeの実装を要求するbehaviour</span>
  <span class="hljs-variable">@behaviour</span> <span class="hljs-title class_">Ecto</span>.<span class="hljs-title class_">Type</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">type</span></span>, <span class="hljs-symbol">do:</span> <span class="hljs-symbol">:id</span>

  <span class="hljs-comment"># changesetのcast関数が呼び出される時とかクエリを構築する時とかに使われる</span>
  <span class="hljs-comment"># 文字列の場合</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cast</span></span>(binary) <span class="hljs-keyword">when</span> is_binary(binary) <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Integer</span>.parse(binary) <span class="hljs-keyword">do</span>
      {int, _} <span class="hljs-keyword">when</span> int &gt; <span class="hljs-number">0</span> -&gt; {<span class="hljs-symbol">:ok</span>, int}
      _ -&gt; <span class="hljs-symbol">:error</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cast</span></span>(integer) <span class="hljs-keyword">when</span> is_integer(integer) <span class="hljs-keyword">do</span>
    {<span class="hljs-symbol">:ok</span>, integer}
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cast</span></span>(_) <span class="hljs-keyword">do</span>
    <span class="hljs-symbol">:error</span>
  <span class="hljs-keyword">end</span>

  <span class="hljs-comment"># データがデータベースに送信される時に呼び出される</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dump</span></span>(integer) <span class="hljs-keyword">when</span> is_integer(integer) <span class="hljs-keyword">do</span>
    {<span class="hljs-symbol">:ok</span>, integer}
  <span class="hljs-keyword">end</span>

  <span class="hljs-comment"># データがデータベースからロードされる時に呼び出される</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load</span></span>(integer) <span class="hljs-keyword">when</span> is_integer(integer) <span class="hljs-keyword">do</span>
    {<span class="hljs-symbol">:ok</span>, integer}
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>データが呼び出されたり、突っ込まれたりするときの動作を記述しています。 今回関係があるのは一つ目の <code>cast/1</code> 関数で、文字列を <code>binary</code> として受け取り、先頭の数字とそれ以外でパースしている部分です。</p>
<p>この処理により、 <code>3-hello</code> のようなパラメータも受取が可能になります。 上記作ったものを利用できるように <code>video.ex</code> を編集します。</p>
<pre><code class="language-Elixir hljs"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">Rumbl.Video</span></span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">use</span> <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Web</span>, <span class="hljs-symbol">:model</span>

  <span class="hljs-comment"># idフィールドのカスタマイズ 第二要素は型らしい</span>
  <span class="hljs-variable">@primary_key</span> {<span class="hljs-symbol">:id</span>, <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Permalink</span>, <span class="hljs-symbol">autogenerate:</span> <span class="hljs-literal">true</span>}
  schema <span class="hljs-string">"videos"</span> <span class="hljs-keyword">do</span>
    field <span class="hljs-symbol">:url</span>, <span class="hljs-symbol">:string</span>
    field <span class="hljs-symbol">:title</span>, <span class="hljs-symbol">:string</span>
    field <span class="hljs-symbol">:description</span>, <span class="hljs-symbol">:string</span>
    field <span class="hljs-symbol">:slug</span>, <span class="hljs-symbol">:string</span>
    belongs_to <span class="hljs-symbol">:user</span>, <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">User</span>

    belongs_to <span class="hljs-symbol">:category</span>, <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Category</span>

    timestamps()
  <span class="hljs-keyword">end</span>
...
</code></pre>
<p><a href="mailto:``@praimary">``@praimary</a>_key<code> アトリビュートを使ってプライマリーキーをカスタマイズしています。
</code>:id<code> 以外をキーとしたい場合も似たような感じで書けば出来るようです。

ここまでやればビデオ閲覧画面は完成です。

============================================
まとめ
============================================

- </code>Phoenix.Param<code> を </code>impl<code> することでURLパラメータがカスタマイズ出来る。
- </code>@primary_key<code> でプライマリーキーをカスタマイズ出来る。

ちょっと短かったです・・・バランスが難しい。

</code>@primary_key`` の2個目の要素の型指定とかまだちょっと疑問が残るので追々調べてみようと思います。</p>
</section>
</section>


  </div>
</article>


<hr>

<nav class="post-navigation">
  <ul>
    <li>
      ← Previous: <a href="/posts/programming-phoenix13/" rel="prev">Programming Phoenix勉強その13</a>
    </li>
    
    <li>
      <strong>Next: <a href="/posts/programming-phoenix15/" rel="next">Programming Phoenix勉強その15</a> →</strong>
    </li>
    
  </ul>
</nav>
      </div>
      <div class="sidebar">
        <aside>
          <section>
            <ul>
              <li>
                <h4>
                  <i class="fa-solid fa-link"></i>
                  <span>Social</span>
                </h4>
                <ul>
                  <li>
                    <i class="fa-brands fa-twitter"></i>
                    <span><a href="https://twitter.com/nuhera" target="_blank" rel="noopener noreferrer">Twitter</a></span>
                </li></ul>
              </li>
              <li>
                <h4>
                  <i class="fa-solid fa-newspaper"></i>
                  <span>Recent Posts</span>
                </h4>
                <ul>
                    <li><a href="https://zonuko.github.io/posts/blog-to-lume/">blogをdeno製静的サイトジェネレーターlumeに移植した</a></li>
                    <li><a href="https://zonuko.github.io/posts/clojure-crawler/">Clojureで○○画像を集める</a></li>
                    <li><a href="https://zonuko.github.io/posts/job-change/">そろそろ誕生日だし転職活動しようと思う</a></li>
                    <li><a href="https://zonuko.github.io/posts/professional-clojure1/">Professional Clojureメモその1</a></li>
                    <li><a href="https://zonuko.github.io/posts/inventory/">社会に出て3年間でやってたこと</a></li>
                </ul>
              </li>
              <li>
                <h4><i class="fa-solid fa-tag"></i><span>Tags</span>
                <ul>
                  
                    <li><a href="/tags/career/">career</a></li>
                  
                    <li><a href="/tags/clojure/">clojure</a></li>
                  
                    <li><a href="/tags/deno/">deno</a></li>
                  
                    <li><a href="/tags/elixir/">elixir</a></li>
                  
                    <li><a href="/tags/game/">game</a></li>
                  
                    <li><a href="/tags/javascript/">javascript</a></li>
                  
                    <li><a href="/tags/misc/">misc</a></li>
                  
                    <li><a href="/tags/music/">music</a></li>
                  
                    <li><a href="/tags/phoenix/">phoenix</a></li>
                  
                    <li><a href="/tags/programming/">programming</a></li>
                  
                </ul>
              </h4></li>
            </ul>
        </section></aside>
      </div>
    </main>

    <footer></footer>

    <!-- Current page: /posts/programming-phoenix14/ -->
  

</body></html>