<!DOCTYPE html>
<html lang="ja"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
    <title>
      
        Programming Phoenix勉強その12 | zonukoブログ
      
    </title>
    <meta name="description" content="Programming Phoenixって本を読むその12">
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css"><link rel="stylesheet" href="/styles.css">
    <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="zonukoブログ">
    <link rel="alternate" href="/feed.json" type="application/json" title="zonukoブログ">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <!-- Google tag (gtag.js) -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-89443473-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'UA-89443473-1');
    </script>
    <!-- Google tag (gtag.js) -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-SQ699WG8QE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-SQ699WG8QE');
    </script>

  <script type="text/javascript" src="/pagefind/pagefind-ui.js"></script><script type="text/javascript">window.addEventListener('DOMContentLoaded', () => { new PagefindUI({"element":"#search","showImages":false,"showEmptyFilters":true,"resetStyles":false,"bundlePath":"/pagefind/","baseUrl":"/"}); });</script></head>
  <body>
    <nav class="navbar">
      <a href="/" class="navbar-home">
        <strong>zonukoブログ</strong>
      </a>

      <ul class="navbar-links">
        <li>
          <a href="/about/">
            About
          </a>
        </li>
        <li>
          <a href="/game/">
            Game
          </a>
        </li>
      </ul>

      <div class="navbar-search">
        <div id="search"></div>
      </div>
    </nav>

    <main class="body-post">
      <div class="main-content">
        <article class="post" data-pagefind-body="">
  <div class="post-header">
    <h1 class="post-title">Programming Phoenix勉強その12</h1>

    <nav class="post-tags">
    
      <a href="/tags/phoenix/" class="tag">phoenix</a>
    
      <a href="/tags/elixir/" class="tag">elixir</a>
    
      <a href="/tags/programming/" class="tag">programming</a>
    
    </nav>

    <time class="post-date" datetime="2017-01-29 18:00:00">
      January 29th, 2017
    </time>
    <div class="share">
      <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
      <a href="https://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;"></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
    </div>
  </div>

  <div class="post-body">
    
<section id="programming-phoenix勉強その12
">
<h1>Programming Phoenix勉強その12</h1>
<p>その12です。テストの続きです。ビュー周りのテストからです。</p>
<section id="テンプレートのテスト
">
<h2>テンプレートのテスト</h2>
<p>何個か前の章でやったようにテンプレートのレンダリングも単なる関数なので簡単にテスト可能です。</p>
<pre><code class="language-Elixir hljs"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">Rumbl.VideoViewTest</span></span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">use</span> <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">ConnCase</span>, <span class="hljs-symbol">async:</span> <span class="hljs-literal">true</span>
  <span class="hljs-keyword">import</span> <span class="hljs-title class_">Phoenix</span>.<span class="hljs-title class_">View</span>

  test <span class="hljs-string">"renders index.html"</span>, %{<span class="hljs-symbol">conn:</span> conn} <span class="hljs-keyword">do</span>
    videos = [%<span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Video</span>{<span class="hljs-symbol">id:</span> <span class="hljs-string">"1"</span>, <span class="hljs-symbol">title:</span> <span class="hljs-string">"dogs"</span>},
              %<span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Video</span>{<span class="hljs-symbol">id:</span> <span class="hljs-string">"2"</span>, <span class="hljs-symbol">title:</span> <span class="hljs-string">"cats"</span>}]
    <span class="hljs-comment"># テンプレートを文字列としてレンダリングする</span>
    content = render_to_string(<span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">VideoView</span>, <span class="hljs-string">"index.html"</span>, 
      <span class="hljs-symbol">conn:</span> conn, <span class="hljs-symbol">videos:</span> videos)

    assert <span class="hljs-title class_">String</span>.contains?(content, <span class="hljs-string">"Listing videos"</span>)
    <span class="hljs-comment"># 内包表記は中の式は評価される</span>
    <span class="hljs-keyword">for</span> video &lt;- videos <span class="hljs-keyword">do</span>
      assert <span class="hljs-title class_">String</span>.contains?(content, video.title)
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>

  test <span class="hljs-string">"renders new.html"</span>, %{<span class="hljs-symbol">conn:</span> conn} <span class="hljs-keyword">do</span>
    changeset = <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Video</span>.changeset(%<span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Video</span>{})
    categories = [{<span class="hljs-string">"cats"</span>, <span class="hljs-number">123</span>}]

    content = render_to_string(<span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">VideoView</span>, <span class="hljs-string">"new.html"</span>,
      <span class="hljs-symbol">conn:</span> conn, <span class="hljs-symbol">changeset:</span> changeset, <span class="hljs-symbol">categories:</span> categories)

    assert <span class="hljs-title class_">String</span>.contains?(content, <span class="hljs-string">"New video"</span>)
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>注目すべきは <code>render_to_string</code> 関数でテンプレートを文字列としてレンダリングしている点かと思います。 実際にレンダリングをHTMLとして行わなくてもテストが出来ています。 <code>render_to_string</code> 関数のオプションにテンプレート側で使う変数を割り当てられるようです。</p>
</section>
<section id="モデルのテスト（非同期）
">
<h2>モデルのテスト（非同期）</h2>
<p>モデルのテストを行う前に <code>model_case.ex</code> を確認しておきます。ついでに <code>import Rumbl.TestHelpers</code> を追記もしておきます。</p>
<pre><code class="language-Elixir hljs"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">Rumbl.ModelCase</span></span> <span class="hljs-keyword">do</span>

  <span class="hljs-keyword">use</span> <span class="hljs-title class_">ExUnit</span>.<span class="hljs-title class_">CaseTemplate</span>

  using <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">quote</span> <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">alias</span> <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Repo</span>

      <span class="hljs-keyword">import</span> <span class="hljs-title class_">Ecto</span>
      <span class="hljs-keyword">import</span> <span class="hljs-title class_">Ecto</span>.<span class="hljs-title class_">Changeset</span>
      <span class="hljs-keyword">import</span> <span class="hljs-title class_">Ecto</span>.<span class="hljs-title class_">Query</span>

      <span class="hljs-keyword">import</span> <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">TestHelpers</span>
      <span class="hljs-keyword">import</span> <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">ModelCase</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>

  setup tags <span class="hljs-keyword">do</span>
    <span class="hljs-symbol">:ok</span> = <span class="hljs-title class_">Ecto</span>.<span class="hljs-title class_">Adapters</span>.<span class="hljs-title class_">SQL</span>.<span class="hljs-title class_">Sandbox</span>.checkout(<span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Repo</span>)

    <span class="hljs-keyword">unless</span> tags[<span class="hljs-symbol">:async</span>] <span class="hljs-keyword">do</span>
      <span class="hljs-title class_">Ecto</span>.<span class="hljs-title class_">Adapters</span>.<span class="hljs-title class_">SQL</span>.<span class="hljs-title class_">Sandbox</span>.mode(<span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Repo</span>, {<span class="hljs-symbol">:shared</span>, self()})
    <span class="hljs-keyword">end</span>

    <span class="hljs-symbol">:ok</span>
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">errors_on</span></span>(struct, data) <span class="hljs-keyword">do</span>
    struct.__struct__.changeset(struct, data)
    |&gt; <span class="hljs-title class_">Ecto</span>.<span class="hljs-title class_">Changeset</span>.traverse_errors(&amp;<span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">ErrorHelpers</span>.translate_error/<span class="hljs-number">1</span>)
    |&gt; <span class="hljs-title class_">Enum</span>.flat_map(<span class="hljs-keyword">fn</span> {key, errors} -&gt; <span class="hljs-keyword">for</span> msg &lt;- errors, <span class="hljs-symbol">do:</span> {key, msg} <span class="hljs-keyword">end</span>)
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>書籍と比べて <code>error_on</code> 関数が変更されてますが余りきにしなくて良さそうです。ぱっとみエラーメッセージをマップに変更しているだけに見えます。</p>
<p><code>model/user_test.exs</code> を作成し以下のように実装します。</p>
<pre><code class="language-Elixir hljs"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">Rumbl.UserTest</span></span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">use</span> <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">ModelCase</span>, <span class="hljs-symbol">async:</span> <span class="hljs-literal">true</span>
  <span class="hljs-keyword">alias</span> <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">User</span>

  <span class="hljs-variable">@valid_attrs</span> %{<span class="hljs-symbol">name:</span> <span class="hljs-string">"A User"</span>, <span class="hljs-symbol">username:</span> <span class="hljs-string">"eva"</span>, <span class="hljs-symbol">password:</span> <span class="hljs-string">"secret"</span>}
  <span class="hljs-variable">@invalid_attrs</span> %{}

  test <span class="hljs-string">"changeset with valid attributes"</span> <span class="hljs-keyword">do</span>
    changeset = <span class="hljs-title class_">User</span>.changeset(%<span class="hljs-title class_">User</span>{}, <span class="hljs-variable">@valid_attrs</span>)
    assert changeset.valid?
  <span class="hljs-keyword">end</span>

  test <span class="hljs-string">"changeset with invalid attributes"</span> <span class="hljs-keyword">do</span>
    changeset = <span class="hljs-title class_">User</span>.changeset(%<span class="hljs-title class_">User</span>{}, <span class="hljs-variable">@invalid_attrs</span>)
    refute changeset.valid?
  <span class="hljs-keyword">end</span>

  test <span class="hljs-string">"changeset does not accepts long usernames"</span> <span class="hljs-keyword">do</span>
    attrs = <span class="hljs-title class_">Map</span>.put(<span class="hljs-variable">@valid_attrs</span>, <span class="hljs-symbol">:username</span>, <span class="hljs-title class_">String</span>.duplicate(<span class="hljs-string">"a"</span>, <span class="hljs-number">30</span>))

    assert {<span class="hljs-symbol">:username</span>, <span class="hljs-string">"should be at most 20 character(s)"</span>} <span class="hljs-keyword">in</span>
      errors_on(%<span class="hljs-title class_">User</span>{}, attrs)
  <span class="hljs-keyword">end</span>

  test <span class="hljs-string">"registration_changeset password must be at least 6 chars long"</span> <span class="hljs-keyword">do</span>
    attrs = <span class="hljs-title class_">Map</span>.put(<span class="hljs-variable">@valid_attrs</span>, <span class="hljs-symbol">:password</span>, <span class="hljs-string">"12345"</span>)
    changeset = <span class="hljs-title class_">User</span>.registration_changeset(%<span class="hljs-title class_">User</span>{}, attrs)
    assert {<span class="hljs-symbol">:password</span>, {<span class="hljs-string">"should be at least %{count} character(s)"</span>, [<span class="hljs-symbol">count:</span> <span class="hljs-number">6</span>, <span class="hljs-symbol">validation:</span> <span class="hljs-symbol">:length</span>, <span class="hljs-symbol">min:</span> <span class="hljs-number">6</span>]}}
      <span class="hljs-keyword">in</span> changeset.errors
  <span class="hljs-keyword">end</span>

  test <span class="hljs-string">"registration_changeset with valid attributes hashes password"</span> <span class="hljs-keyword">do</span>
    attrs = <span class="hljs-title class_">Map</span>.put(<span class="hljs-variable">@valid_attrs</span>, <span class="hljs-symbol">:password</span>, <span class="hljs-string">"123456"</span>)
    changeset = <span class="hljs-title class_">User</span>.registration_changeset(%<span class="hljs-title class_">User</span>{}, attrs)

    %{<span class="hljs-symbol">password:</span> pass, <span class="hljs-symbol">password_hash:</span> pass_hash} = changeset.changes

    assert changeset.valid?
    assert pass_hash
    assert <span class="hljs-title class_">Comeonin</span>.<span class="hljs-title class_">Bcrypt</span>.checkpw(pass, pass_hash)
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p><code>erros_on</code> を使っている場所は <a href="https://forums.pragprog.com/forums/393/topics/14486">ここを参考</a>  にしました。 これらのテストは副作用を起こさないテストでまとめたため、 <code>async: true</code> にして並列実行しているようです。</p>
</section>
<section id="副作用のあるテスト
">
<h2>副作用のあるテスト</h2>
<p>副作用が無く非同期に実行できるテストに対して、実際に <code>Repo.insert</code> したりするようなテストは副作用が発生します。その為、同じモデルのテストでも副作用あり/無しで分離してテストを書きます。</p>
<p><code>model/user_repo_test.exs</code> を以下のように作成します。</p>
<pre><code class="language-Elixir hljs"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">Rumbl.UserRepoTest</span></span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">use</span> <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">ModelCase</span>
  <span class="hljs-keyword">alias</span> <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">User</span>

  <span class="hljs-variable">@valid_attrs</span> %{<span class="hljs-symbol">name:</span> <span class="hljs-string">"A User"</span>, <span class="hljs-symbol">username:</span> <span class="hljs-string">"eva"</span>}

  test <span class="hljs-string">"converts unique_constraint on username to error"</span> <span class="hljs-keyword">do</span>
    insert_user(<span class="hljs-symbol">username:</span> <span class="hljs-string">"eric"</span>)
    attrs = <span class="hljs-title class_">Map</span>.put(<span class="hljs-variable">@valid_attrs</span>, <span class="hljs-symbol">:username</span>, <span class="hljs-string">"eric"</span>)
    changeset = <span class="hljs-title class_">User</span>.changeset(%<span class="hljs-title class_">User</span>{}, attrs)

    assert {<span class="hljs-symbol">:error</span>, changeset} = <span class="hljs-title class_">Repo</span>.insert(changeset)
    <span class="hljs-comment"># changeset.errorsはキーワードリストになっている</span>
    <span class="hljs-comment"># キーワードリストの各要素は最初の値がアトムとなるタプルとしても認識される</span>
    assert {<span class="hljs-symbol">:username</span>, {<span class="hljs-string">"has already been taken"</span>, []}} <span class="hljs-keyword">in</span> changeset.errors
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>実際にインサートを行っている以外には大した違いが無いです。 <code>async</code> オプションはデフォルトで <code>false</code> なので指定をしていません。 関係ないですが、キーワードリストについて忘れてて若干ハマりました・・・</p>
<p>同様に <code>category_repo_test.exs</code> を以下のように作ります。</p>
<pre><code class="language-Elixir hljs"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">Rumbl.CategoryRepoTest</span></span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">use</span> <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">ModelCase</span>
  <span class="hljs-keyword">alias</span> <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Category</span>

  test <span class="hljs-string">"alphabetical/1 orders by name"</span> <span class="hljs-keyword">do</span>
    <span class="hljs-title class_">Repo</span>.insert!(%<span class="hljs-title class_">Category</span>{<span class="hljs-symbol">name:</span> <span class="hljs-string">"c"</span>})
    <span class="hljs-title class_">Repo</span>.insert!(%<span class="hljs-title class_">Category</span>{<span class="hljs-symbol">name:</span> <span class="hljs-string">"a"</span>})
    <span class="hljs-title class_">Repo</span>.insert!(%<span class="hljs-title class_">Category</span>{<span class="hljs-symbol">name:</span> <span class="hljs-string">"b"</span>})

    query = <span class="hljs-title class_">Category</span> |&gt; <span class="hljs-title class_">Category</span>.alphabetical()
    query = from c <span class="hljs-keyword">in</span> query, <span class="hljs-symbol">select:</span> c.name
    assert <span class="hljs-title class_">Repo</span>.all(query) == <span class="hljs-string">~w(a b c)</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>別段躓くところはなかったです。</p>
</section>
<section id="まとめ
">
<h2>まとめ</h2>
<ul>
<li><p>ビューは単なる関数なので <code>render_to_string</code> などを使って簡単にテストができる。</p></li>
<li><p>副作用が無いテストを分離することで非同期にテストを実行できる。</p></li>
</ul>
<p><code>NUnit</code> とか使ってうっかり先に書いたテストに依存するようなテストを書いちゃうことは結構ありましたが、今回のように改めてテストの同期/非同期を意識したのは新鮮でした。 書籍の区分け的にはここで一段落です。以降からパート2に入ります。 <code>Channel</code> とかは目玉昨日の一つだと思うのでやっていきます。</p>
</section>
</section>


  </div>
</article>


<hr>

<nav class="post-navigation">
  <ul>
    <li>
      ← Previous: <a href="/posts/programming-phoenix11/" rel="prev">Programming Phoenix勉強その11</a>
    </li>
    
    <li>
      <strong>Next: <a href="/posts/programming-phoenix13/" rel="next">Programming Phoenix勉強その13</a> →</strong>
    </li>
    
  </ul>
</nav>
      </div>
      <div class="sidebar">
        <aside>
          <section>
            <ul>
              <li>
                <h4>
                  <i class="fa-solid fa-link"></i>
                  <span>Social</span>
                </h4>
                <ul>
                  <li>
                    <i class="fa-brands fa-twitter"></i>
                    <span><a href="https://twitter.com/nuhera" target="_blank" rel="noopener noreferrer">Twitter</a></span>
                </li></ul>
              </li>
              <li>
                <h4>
                  <i class="fa-solid fa-newspaper"></i>
                  <span>Recent Posts</span>
                </h4>
                <ul>
                    <li><a href="https://zonuko.github.io/posts/blog-to-lume/">blogをdeno製静的サイトジェネレーターlumeに移植した</a></li>
                    <li><a href="https://zonuko.github.io/posts/clojure-crawler/">Clojureで○○画像を集める</a></li>
                    <li><a href="https://zonuko.github.io/posts/job-change/">そろそろ誕生日だし転職活動しようと思う</a></li>
                    <li><a href="https://zonuko.github.io/posts/professional-clojure1/">Professional Clojureメモその1</a></li>
                    <li><a href="https://zonuko.github.io/posts/inventory/">社会に出て3年間でやってたこと</a></li>
                </ul>
              </li>
              <li>
                <h4><i class="fa-solid fa-tag"></i><span>Tags</span>
                <ul>
                  
                    <li><a href="/tags/career/">career</a></li>
                  
                    <li><a href="/tags/clojure/">clojure</a></li>
                  
                    <li><a href="/tags/deno/">deno</a></li>
                  
                    <li><a href="/tags/elixir/">elixir</a></li>
                  
                    <li><a href="/tags/game/">game</a></li>
                  
                    <li><a href="/tags/javascript/">javascript</a></li>
                  
                    <li><a href="/tags/misc/">misc</a></li>
                  
                    <li><a href="/tags/music/">music</a></li>
                  
                    <li><a href="/tags/phoenix/">phoenix</a></li>
                  
                    <li><a href="/tags/programming/">programming</a></li>
                  
                </ul>
              </h4></li>
            </ul>
        </section></aside>
      </div>
    </main>

    <footer></footer>

    <!-- Current page: /posts/programming-phoenix12/ -->
  

</body></html>