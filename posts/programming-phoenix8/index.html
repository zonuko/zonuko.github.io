<!DOCTYPE html>
<html lang="ja"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
    <title>
      
        Programming Phoenix勉強その8 | zonukoブログ
      
    </title>
    <meta name="description" content="Programming Phoenixって本を読むその8">
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css"><link rel="stylesheet" href="/styles.css">
    <link rel="alternate" href="/feed.xml" type="application/atom+xml" title="zonukoブログ">
    <link rel="alternate" href="/feed.json" type="application/json" title="zonukoブログ">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <!-- Google tag (gtag.js) -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-89443473-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'UA-89443473-1');
    </script>
    <!-- Google tag (gtag.js) -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-SQ699WG8QE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-SQ699WG8QE');
    </script>

  <script type="text/javascript" src="/pagefind/pagefind-ui.js"></script><script type="text/javascript">window.addEventListener('DOMContentLoaded', () => { new PagefindUI({"element":"#search","showImages":false,"showEmptyFilters":true,"resetStyles":false,"bundlePath":"/pagefind/","baseUrl":"/"}); });</script></head>
  <body>
    <nav class="navbar">
      <a href="/" class="navbar-home">
        <strong>zonukoブログ</strong>
      </a>

      <ul class="navbar-links">
        <li>
          <a href="/about/">
            About
          </a>
        </li>
        <li>
          <a href="/game/">
            Game
          </a>
        </li>
      </ul>

      <div class="navbar-search">
        <div id="search"></div>
      </div>
    </nav>

    <main class="body-post">
      <div class="main-content">
        <article class="post" data-pagefind-body="">
  <div class="post-header">
    <h1 class="post-title">Programming Phoenix勉強その8</h1>

    <nav class="post-tags">
    
      <a href="/tags/programming/" class="tag">programming</a>
    
      <a href="/tags/elixir/" class="tag">elixir</a>
    
      <a href="/tags/phoenix/" class="tag">phoenix</a>
    
    </nav>

    <time class="post-date" datetime="2017-01-21 22:21:00">
      January 21st, 2017
    </time>
    <div class="share">
      <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
      <a href="https://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;"></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
    </div>
  </div>

  <div class="post-body">
    
<section id="programming-phoenix勉強その8
">
<h1>Programming Phoenix勉強その8</h1>
<p>その8です。 ここからchapter6です。 <code>Ecto</code> をコードジェネレータを色々探るみたいです。</p>
<section id="コードジェネレータの利用
">
<h2>コードジェネレータの利用</h2>
<p>早速コードジェネレータを使ってみます。 <code>rumbl</code> ビデオにコメントを付けられるアプリなので <code>Video</code> 周りが色々と必要そうです。 <code>Video</code> 周りのものはコードジェネレータにおまかせしてみます。以下のコマンドを入力します。</p>
<pre><code class="language-shell hljs">rumbl $ mix phoenix.gen.html Video videos user_id:references:users url:string title:string description:text
</code></pre>
<p>モデル名の複数形とかモジュール名とかフィールドの型情報とかを与えてやっています。 マイグレーションの前に下準備を行います。  認証処理は共有で使いたいので <code>user_controller.ex</code> にあった <code>authenticate/2</code> 関数は <code>auth.ex</code> に外出して置きます。</p>
<pre><code class="language-Elixir hljs"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">Rumbl.Auth</span></span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">import</span> <span class="hljs-title class_">Phoenix</span>.<span class="hljs-title class_">Controller</span>
  <span class="hljs-keyword">alias</span> <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Router</span>.<span class="hljs-title class_">Helpers</span>
  ...
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">authenticate_user</span></span>(conn, _opts) <span class="hljs-keyword">do</span>
    <span class="hljs-comment"># Plugで追加したassignの呼び出しが可能かどうか</span>
    <span class="hljs-keyword">if</span> conn.assigns.current_user <span class="hljs-keyword">do</span>
      conn
    <span class="hljs-keyword">else</span>
      conn
      |&gt; put_flash(<span class="hljs-symbol">:error</span>, <span class="hljs-string">"You must be logged in to access that page"</span>)
      |&gt; redirect(<span class="hljs-symbol">to:</span> <span class="hljs-title class_">Helpers</span>.page_path(conn, <span class="hljs-symbol">:index</span>))
      |&gt; halt()
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p><code>web.ex</code> に以下を追加して全コントローラーとルーターで上記の認証関数を使えるようにします。</p>
<pre><code class="language-Elixir hljs">...
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">controller</span></span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">quote</span> <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">use</span> <span class="hljs-title class_">Phoenix</span>.<span class="hljs-title class_">Controller</span>

    <span class="hljs-keyword">alias</span> <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Repo</span>
    <span class="hljs-keyword">import</span> <span class="hljs-title class_">Ecto</span>
    <span class="hljs-keyword">import</span> <span class="hljs-title class_">Ecto</span>.<span class="hljs-title class_">Query</span>

    <span class="hljs-keyword">import</span> <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Router</span>.<span class="hljs-title class_">Helpers</span>
    <span class="hljs-keyword">import</span> <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Gettext</span>
    <span class="hljs-keyword">import</span> <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Auth</span>, <span class="hljs-symbol">only:</span> [<span class="hljs-symbol">authenticate_user:</span> <span class="hljs-number">2</span>] <span class="hljs-comment"># 追加</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
...
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">router</span></span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">quote</span> <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">use</span> <span class="hljs-title class_">Phoenix</span>.<span class="hljs-title class_">Router</span>

    <span class="hljs-keyword">import</span> <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Auth</span>, <span class="hljs-symbol">only:</span> [<span class="hljs-symbol">authenticate_user:</span> <span class="hljs-number">2</span>] <span class="hljs-comment"># 追加</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p> 当然、 <code>user_controller.ex</code> の認証プラグも <code>authenticate_user</code> に変えておきます。  <code>router.ex</code> に新しいスコープを追加します。</p>
<pre><code class="language-Elixir hljs">scope <span class="hljs-string">"/manage"</span>, <span class="hljs-title class_">Rumbl</span> <span class="hljs-keyword">do</span>
  pipe_through [<span class="hljs-symbol">:browser</span>, <span class="hljs-symbol">:authenticate_user</span>]

  resouces <span class="hljs-string">"/videos"</span>, <span class="hljs-title class_">VideoController</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>ここまで行ってマイグレーションを行います。 空白文字の扱いについては、 <code>controller</code> 内に <code>scrub_param</code> という <code>Plug</code> が定義されており、これによって自動で <code>nil</code> に変換されているらしいです。 ついでに <code>Model</code> を見に行くとバージョンの違いが結構生成されたものが異なってます。何個か前の章で書いた用に <code>cast/4</code> 関数が非推奨になっているからです。 <code>user_id</code> を外部キーにしてるので、 <code>user.ex</code> も変更しておきます。</p>
<pre><code class="language-Elixir hljs">schema <span class="hljs-string">"users"</span> <span class="hljs-keyword">do</span>
  field <span class="hljs-symbol">:name</span>, <span class="hljs-symbol">:string</span>
  field <span class="hljs-symbol">:username</span>, <span class="hljs-symbol">:string</span>
  field <span class="hljs-symbol">:password</span>, <span class="hljs-symbol">:string</span>, <span class="hljs-symbol">virtual:</span> <span class="hljs-literal">true</span>
  field <span class="hljs-symbol">:password_hash</span>, <span class="hljs-symbol">:string</span>
  has_many <span class="hljs-symbol">:videos</span>, <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Video</span> <span class="hljs-comment"># 追加</span>

  timestamps()
<span class="hljs-keyword">end</span>
</code></pre>
</section>
<section id="ectoについて
">
<h2>Ectoについて</h2>
<p>ここで説明される <code>Ecto</code> の関数は以下</p>
<ul><li><p><code>Ecto.build_assoc/3</code> </p><p>  第一引数と関連する第二引数引数の構造体を第三引数の <code>Map</code> の構造で作る</p></li></ul>
<ul><li><p><code>Ecto.assoc/2</code></p><p>  第一引数に対して <code>has_many</code> になっている第二引数の構造体を取り出すクエリを生成する。コンソール見ると LINQ to SQLっぽいのが流れてた</p></li></ul>
<p>毎回のように翻訳と理解が正しいか怪しい・・・</p>
</section>
<section id="自動生成されたコードの調整
">
<h2>自動生成されたコードの調整</h2>
<p>自動生成されたコードを調整します。 まずは <code>video_controller.ex</code> の <code>:new</code> アクションを変更します。</p>
<pre><code class="language-Elixir hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">new</span></span>(conn, _params) <span class="hljs-keyword">do</span>
  changeset = 
    conn.assigns.current_user
    |&gt; build_assoc(<span class="hljs-symbol">:videos</span>) <span class="hljs-comment"># current_userに関連するVideo構造体を作成</span>
    |&gt; <span class="hljs-title class_">Video</span>.changeset() <span class="hljs-comment"># 上記Video構造体からchangeset作成</span>

  render(conn, <span class="hljs-string">"new.html"</span>, <span class="hljs-symbol">changeset:</span> changeset)
<span class="hljs-keyword">end</span>
</code></pre>
<p><code>Video</code> の <code>changeset</code> を作るだけだったのをログイン中のユーザに関連する <code>Video</code> にするように変更しました。 <code>current_user</code> は色んな所で出てきそうで鬱陶しいのでまとめられう方法を探します。幸いなことにカスタムアクションなるものがあるようです。 以下の関数を <code>video_controller.ex</code> に追加します。</p>
<pre><code class="language-Elixir hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">action</span></span>(conn, _) <span class="hljs-keyword">do</span>
  apply(__MODULE__, action_name(conn), [conn, conn.params, conn.assigns.current_user])
<span class="hljs-keyword">end</span>
</code></pre>
<p>パット見わけがわかりませんが簡単です。 まず <code>apply/3</code> 関数はモジュール名、関数名のアトム、その関数に適用する引数を取る関数です。（ <a href="https://hexdocs.pm/elixir/Kernel.html">Elixirの組み込みです。</a> ） <code>__MODULE__</code> は現在のモジュール名で、 <code>action_name/1</code> は <code>conn</code> が要求するアクション名を返してくる関数です。（ <a href="https://hexdocs.pm/phoenix/Phoenix.Controller.html">Phoenix側で用意されている。</a> ） こんな感じにしてやると <code>video_controller.ex</code> の全アクションは上記の第三引数の引数を取るようにカスタマイズされてくれます。 なのでアクションを書き換えます。</p>
<pre><code class="language-Elixir hljs"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">Rumbl.VideoController</span></span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">use</span> <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Web</span>, <span class="hljs-symbol">:controller</span>

  <span class="hljs-keyword">alias</span> <span class="hljs-title class_">Rumbl</span>.<span class="hljs-title class_">Video</span>

  <span class="hljs-comment"># カスタムアクションで各アクションをカスタマイズする</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">action</span></span>(conn, _) <span class="hljs-keyword">do</span>
    <span class="hljs-comment"># 第一引数のモジュールの第二引数の関数に第三引数の引数を渡して実行する</span>
    apply(__MODULE__, action_name(conn), [conn, conn.params, conn.assigns.current_user])
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index</span></span>(conn, _params, user) <span class="hljs-keyword">do</span>
    videos = <span class="hljs-title class_">Repo</span>.all(user_videos(user))
    render(conn, <span class="hljs-string">"index.html"</span>, <span class="hljs-symbol">videos:</span> videos)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">new</span></span>(conn, _params, user) <span class="hljs-keyword">do</span>
    changeset = 
      user
      |&gt; build_assoc(<span class="hljs-symbol">:videos</span>) <span class="hljs-comment"># current_userに関連するVideo構造体を作成</span>
      |&gt; <span class="hljs-title class_">Video</span>.changeset() <span class="hljs-comment"># 上記Video構造体からchangeset作成中身は空</span>

    render(conn, <span class="hljs-string">"new.html"</span>, <span class="hljs-symbol">changeset:</span> changeset)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create</span></span>(conn, %{<span class="hljs-string">"video"</span> =&gt; video_params}, user) <span class="hljs-keyword">do</span>
    changeset = 
      user
      |&gt; build_assoc(<span class="hljs-symbol">:videos</span>) <span class="hljs-comment"># current_userに関連するVideo構造体を作成</span>
      |&gt; <span class="hljs-title class_">Video</span>.changeset(video_params) <span class="hljs-comment"># 上記Video構造体からchangeset作成</span>

    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Repo</span>.insert(changeset) <span class="hljs-keyword">do</span>
      {<span class="hljs-symbol">:ok</span>, _video} -&gt;
        conn
        |&gt; put_flash(<span class="hljs-symbol">:info</span>, <span class="hljs-string">"Video created successfully."</span>)
        |&gt; redirect(<span class="hljs-symbol">to:</span> video_path(conn, <span class="hljs-symbol">:index</span>))
      {<span class="hljs-symbol">:error</span>, changeset} -&gt;
        render(conn, <span class="hljs-string">"new.html"</span>, <span class="hljs-symbol">changeset:</span> changeset)
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span></span>(conn, %{<span class="hljs-string">"id"</span> =&gt; id}, user, user) <span class="hljs-keyword">do</span>
    video = <span class="hljs-title class_">Repo</span>.get!(user_videos(user), id)
    render(conn, <span class="hljs-string">"show.html"</span>, <span class="hljs-symbol">video:</span> video)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span></span>(conn, %{<span class="hljs-string">"id"</span> =&gt; id}, user) <span class="hljs-keyword">do</span>
    video = <span class="hljs-title class_">Repo</span>.get!(user_videos(user), id)
    changeset = <span class="hljs-title class_">Video</span>.changeset(video)
    render(conn, <span class="hljs-string">"edit.html"</span>, <span class="hljs-symbol">video:</span> video, <span class="hljs-symbol">changeset:</span> changeset)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update</span></span>(conn, %{<span class="hljs-string">"id"</span> =&gt; id, <span class="hljs-string">"video"</span> =&gt; video_params}, user) <span class="hljs-keyword">do</span>
    video = <span class="hljs-title class_">Repo</span>.get!(user_videos(user), id)
    changeset = <span class="hljs-title class_">Video</span>.changeset(video, video_params)

    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Repo</span>.update(changeset) <span class="hljs-keyword">do</span>
      {<span class="hljs-symbol">:ok</span>, video} -&gt;
        conn
        |&gt; put_flash(<span class="hljs-symbol">:info</span>, <span class="hljs-string">"Video updated successfully."</span>)
        |&gt; redirect(<span class="hljs-symbol">to:</span> video_path(conn, <span class="hljs-symbol">:show</span>, video))
      {<span class="hljs-symbol">:error</span>, changeset} -&gt;
        render(conn, <span class="hljs-string">"edit.html"</span>, <span class="hljs-symbol">video:</span> video, <span class="hljs-symbol">changeset:</span> changeset)
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete</span></span>(conn, %{<span class="hljs-string">"id"</span> =&gt; id}, user) <span class="hljs-keyword">do</span>
    video = <span class="hljs-title class_">Repo</span>.get!(user_videos(user), id)

    <span class="hljs-comment"># Here we use delete! (with a bang) because we expect</span>
    <span class="hljs-comment"># it to always work (and if it does not, it will raise).</span>
    <span class="hljs-title class_">Repo</span>.delete!(video)

    conn
    |&gt; put_flash(<span class="hljs-symbol">:info</span>, <span class="hljs-string">"Video deleted successfully."</span>)
    |&gt; redirect(<span class="hljs-symbol">to:</span> video_path(conn, <span class="hljs-symbol">:index</span>))
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">user_videos</span></span>(user) <span class="hljs-keyword">do</span>
    assoc(user, <span class="hljs-symbol">:videos</span>)
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p><code>current_user</code> を取り出して使っていたのをカスタムアクションによって引数で取ることができるようになりました。 <code>show</code> アクションなどではユーザに関係のある一覧が欲しいので <code>user_videos/1</code> 関数を用意してあります。 これで <code>Video</code> 周りの実装は一旦修了です。</p>
</section>
<section id="まとめ
">
<h2>まとめ</h2>
<ul>
<li><p><code>assoc</code> で対象に関係のあるデータが取得できる。</p></li>
<li><p>コードジェネレータやルーティングについては他の言語とほとんど変わりがない</p></li>
</ul>
</section>
</section>


  </div>
</article>


<hr>

<nav class="post-navigation">
  <ul>
    <li>
      ← Previous: <a href="/posts/programming-phoenix7/" rel="prev">Programming Phoenix勉強その7</a>
    </li>
    
    <li>
      <strong>Next: <a href="/posts/programming-phoenix9/" rel="next">Programming Phoenix勉強その9</a> →</strong>
    </li>
    
  </ul>
</nav>
      </div>
      <div class="sidebar">
        <aside>
          <section>
            <ul>
              <li>
                <h4>
                  <i class="fa-solid fa-link"></i>
                  <span>Social</span>
                </h4>
                <ul>
                  <li>
                    <i class="fa-brands fa-twitter"></i>
                    <span><a href="https://twitter.com/nuhera" target="_blank" rel="noopener noreferrer">Twitter</a></span>
                </li></ul>
              </li>
              <li>
                <h4>
                  <i class="fa-solid fa-newspaper"></i>
                  <span>Recent Posts</span>
                </h4>
                <ul>
                    <li><a href="https://zonuko.github.io/posts/blog-to-lume/">blogをdeno製静的サイトジェネレーターlumeに移植した</a></li>
                    <li><a href="https://zonuko.github.io/posts/clojure-crawler/">Clojureで○○画像を集める</a></li>
                    <li><a href="https://zonuko.github.io/posts/job-change/">そろそろ誕生日だし転職活動しようと思う</a></li>
                    <li><a href="https://zonuko.github.io/posts/professional-clojure1/">Professional Clojureメモその1</a></li>
                    <li><a href="https://zonuko.github.io/posts/inventory/">社会に出て3年間でやってたこと</a></li>
                </ul>
              </li>
              <li>
                <h4><i class="fa-solid fa-tag"></i><span>Tags</span>
                <ul>
                  
                    <li><a href="/tags/career/">career</a></li>
                  
                    <li><a href="/tags/clojure/">clojure</a></li>
                  
                    <li><a href="/tags/deno/">deno</a></li>
                  
                    <li><a href="/tags/elixir/">elixir</a></li>
                  
                    <li><a href="/tags/game/">game</a></li>
                  
                    <li><a href="/tags/javascript/">javascript</a></li>
                  
                    <li><a href="/tags/misc/">misc</a></li>
                  
                    <li><a href="/tags/music/">music</a></li>
                  
                    <li><a href="/tags/phoenix/">phoenix</a></li>
                  
                    <li><a href="/tags/programming/">programming</a></li>
                  
                </ul>
              </h4></li>
            </ul>
        </section></aside>
      </div>
    </main>

    <footer></footer>

    <!-- Current page: /posts/programming-phoenix8/ -->
  

</body></html>